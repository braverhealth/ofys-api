openapi: 3.0.3
info:
    title: Braver Backend API – Provisionnement et Patients
    version: 0.2.2
    description: >
        API consommée par le backend d'Ofys pour provisionner les professionnels et synchroniser des patients.

        ## Modèle de Sécurité

        L'API Backend utilise deux schémas d'authentification JWT:

        1. **providerJwt** (Fournisseur Ofys):
           - Utilisé UNIQUEMENT pour POST /clients
           - Identifie le fournisseur Ofys (pas une clinique spécifique)
           - Claims: iss, aud, sub (identifiant fournisseur), iat, exp

        2. **clinicJwt** (Clinique/Client):
           - Utilisé pour tous les autres endpoints
           - Identifie la clinique/client qui effectue la requête
           - Claims: iss, aud, tid (identifiant clinique), iat, exp

        Chaque requête doit inclure un JWT valide dans l'en-tête:
        ```
        Authorization: Bearer <JWT>
        ```

        Aucun endpoint public. Voir SECURITY.md pour la documentation complète du modèle de sécurité.

        ## Idempotence

        ### Support de l'Idempotency-Key
        Tous les endpoints POST et PUT supportent le header standard `Idempotency-Key` pour garantir l'idempotence.

        **Format**: UUID v4 (ex: `550e8400-e29b-41d4-a716-446655440000`)

        **Durée de garantie**: 1 heure

        **Utilisation**: Inclure le header `Idempotency-Key` dans la requête:
        ```
        POST /clients
        Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000
        ```

        **Comportement**:
        - Si la même requête est envoyée avec la même `Idempotency-Key` dans l'heure, la réponse en cache est retournée
        - Évite les doublons en cas de retry réseau
        - Applicable à: POST /clients, POST /utilisateurs, POST /patients, PUT /utilisateur/{id}, PUT /patient/{id}

servers:
    - url: "<À préciser prochainement>"
      description: Production
    - url: "<À préciser prochainement>"
      description: Sandbox
tags:
    - name: Clients
    - name: Utilisateurs
    - name: Patients
security:
    - clinicJwt: []

paths:
    /clients:
        post:
            tags: [Clients]
            summary: Créer un nouveau client
            description: >
                Crée un nouveau client (clinique/organisation) avec ses lieux de pratique associés.
                Chaque client peut avoir plusieurs lieux de pratique (cliniques, pharmacies, services hospitaliers, etc.).

                **Sécurité**: Authentification requise (providerJwt)

                Note: Cet endpoint utilise providerJwt (identifiant le fournisseur Ofys) et non clinicJwt,
                car le client n'existe pas encore au moment de sa création.
            operationId: createClient
            security:
                - providerJwt: []
            parameters:
                - in: header
                  name: Idempotency-Key
                  schema: { type: string, format: uuid }
                  description: UUID v4 pour garantir l'idempotence (optionnel, durée 1h)
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/ClientCreate'
            responses:
                '201':
                    description: Client créé
                    headers:
                        Location:
                            schema: { type: string }
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Client'
                '400':
                    description: Données invalides
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                            example:
                                error:
                                    code: VALIDATION_REQUIRED_FIELD
                                    message: Le champ 'nom' est obligatoire
                                    details:
                                        field: nom
                                    timestamp: "2025-11-18T14:32:00Z"
                                    traceId: abc-123-def
                '409':
                    description: Client existe déjà
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                            example:
                                error:
                                    code: CLIENT_ALREADY_EXISTS
                                    message: Un client avec l'ID 'clinic-123' existe déjà
                                    details:
                                        clientId: clinic-123
                                    timestamp: "2025-11-18T14:32:00Z"
                                    traceId: abc-123-def

    /utilisateurs:
        post:
            tags: [Utilisateurs]
            summary: Créer un professionnel confirmé (activation DSQ)
            description: >
                Notifie Braver qu'un professionnel confirmé (clé DSQ active) doit obtenir un accès.

                **Sécurité**: Authentification requise (clinicJwt)
            operationId: createUser
            parameters:
                - in: header
                  name: Idempotency-Key
                  schema: { type: string, format: uuid }
                  description: UUID v4 pour garantir l'idempotence (optionnel, durée 1h)
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/UserCreate'
            responses:
                '201':
                    description: Créé
                    headers:
                        Location:
                            schema: { type: string }
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/User'
                '400':
                    description: Données invalides
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                            example:
                                error:
                                    code: VALIDATION_REQUIRED_FIELD
                                    message: Le champ 'prenom' est obligatoire
                                    details:
                                        field: prenom
                                    timestamp: "2025-11-18T14:32:00Z"
                                    traceId: abc-123-def
                '409':
                    description: Utilisateur existe déjà
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                            example:
                                error:
                                    code: USER_ALREADY_EXISTS
                                    message: Un utilisateur avec le ID Ofys existe déjà
                                    details:
                                        userId: prof-123
                                    timestamp: "2025-11-18T14:32:00Z"
                                    traceId: abc-123-def

    /utilisateur/{id}:
        put:
            tags: [Utilisateurs]
            summary: Mettre à jour un professionnel
            description: >
                **Sécurité**: Authentification requise (clinicJwt)
            operationId: updateUser
            parameters:
                - $ref: '#/components/parameters/PathId'
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/UserUpdate'
            responses:
                '200':
                    description: Mis à jour
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/User'
                '400':
                    description: Données invalides
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                '404':
                    description: Utilisateur introuvable
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                            example:
                                error:
                                    code: USER_NOT_FOUND
                                    message: L'utilisateur avec l'ID 'prof-123' n'existe pas
                                    details:
                                        userId: prof-123
                                    timestamp: "2025-11-18T14:32:00Z"
                                    traceId: abc-123-def
        delete:
            tags: [Utilisateurs]
            summary: Désactiver un professionnel (retirer l'accès)
            description: >
                **Sécurité**: Authentification requise (clinicJwt)
            operationId: deleteUser
            parameters:
                - $ref: '#/components/parameters/PathId'
            responses:
                '204': { description: Désactivé }
                '404':
                    description: Utilisateur introuvable
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'

    /patients:
        post:
            tags: [Patients]
            summary: Créer un patient (profil démographique minimal confirmé)
            description: >
                Envoyer uniquement des dossiers complets (id, prénom, nom, dateNaissance, sexeNaissance, nam).

                **Sécurité**: Authentification requise (clinicJwt)
            operationId: createPatient
            parameters:
                - in: header
                  name: Idempotency-Key
                  schema: { type: string, format: uuid }
                  description: UUID v4 pour garantir l'idempotence (optionnel, durée 1h)
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/PatientCreate'
            responses:
                '201':
                    description: Créé
                    headers:
                        Location:
                            schema: { type: string }
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Patient'
                '400':
                    description: Données invalides
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                            example:
                                error:
                                    code: VALIDATION_REQUIRED_FIELD
                                    message: Le champ 'nam' est obligatoire
                                    details:
                                        field: nam
                                    timestamp: "2025-11-18T14:32:00Z"
                                    traceId: abc-123-def
                '409':
                    description: Patient existe déjà
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                            example:
                                error:
                                    code: PATIENT_ALREADY_EXISTS
                                    message: Un patient avec le NAM 'nam-123' existe déjà
                                    details:
                                        nam: nam-123
                                    timestamp: "2025-11-18T14:32:00Z"
                                    traceId: abc-123-def

    /patient/{id}:
        put:
            tags: [Patients]
            summary: Mettre à jour un patient
            description: >
                **Sécurité**: Authentification requise (clinicJwt)
            operationId: updatePatient
            parameters:
                - $ref: '#/components/parameters/PathId'
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/PatientUpdate'
            responses:
                '200':
                    description: Mis à jour
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Patient'
                '400':
                    description: Données invalides
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                '404':
                    description: Patient introuvable
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'
                            example:
                                error:
                                    code: PATIENT_NOT_FOUND
                                    message: Le patient avec l'ID 'patient-123' n'existe pas
                                    details:
                                        patientId: patient-123
                                    timestamp: "2025-11-18T14:32:00Z"
                                    traceId: abc-123-def
        delete:
            tags: [Patients]
            summary: Archiver un patient (décès, désassociation)
            description: >
                **Sécurité**: Authentification requise (clinicJwt)
            operationId: deletePatient
            parameters:
                - $ref: '#/components/parameters/PathId'
            responses:
                '204': { description: Archivé }
                '404':
                    description: Patient introuvable
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ApiError'

components:
    securitySchemes:
        providerJwt:
            type: http
            scheme: bearer
            bearerFormat: JWT
            description: >
                Jeton identifiant le fournisseur Ofys (pour créer des clients).
                Utilisé UNIQUEMENT pour POST /clients.
                Claims suggérés:
                - iss: émetteur Ofys
                - aud: "<installation URL à préciser>"
                - sub: identifiant du fournisseur Ofys
                - iat, exp
        clinicJwt:
            type: http
            scheme: bearer
            bearerFormat: JWT
            description: >
                Jeton backend identifiant la clinique (client).
                Claims suggérés:
                - iss: émetteur Ofys
                - aud: "<installation URL à préciser>"
                - tid: identifiant clinique/client
                - iat, exp
    parameters:
        PathId:
            name: id
            in: path
            required: true
            schema: { type: string }
            description: Identifiant Ofys de l'utilisateur/patient
    schemas:
        UserCreate:
            type: object
            required: [id, prenom, nom, professions, numeroPratique]
            properties:
                id: { type: string, description: Identifiant Ofys }
                prenom: { type: string }
                nom: { type: string }
                courriel:
                    type: string
                    format: email
                    nullable: true
                    description: Peut être ajouté plus tard au premier login
                genre:
                    type: string
                    nullable: true
                    enum: [M, F, O, NA]
                professions:
                    type: array
                    items: { type: string }
                    description: Valeurs fixes à convenir
                numeroPratique:
                    type: string
                    description: Numéro de pratique (ex. numéro de licence)
        UserUpdate:
            type: object
            properties:
                prenom: { type: string }
                nom: { type: string }
                courriel:
                    type: string
                    format: email
                    nullable: true
                genre:
                    type: string
                    nullable: true
                    enum: [M, F, O, NA]
                professions:
                    type: array
                    items: { type: string }
        User:
            allOf:
                - $ref: '#/components/schemas/UserCreate'

        PatientCreate:
            type: object
            required: [id, prenom, nom, dateNaissance, sexeNaissance, nam]
            properties:
                id: { type: string, description: Identifiant Ofys }
                prenom: { type: string }
                nom: { type: string }
                sexeNaissance:
                    type: string
                    nullable: true
                    enum: [M, F, O, NA]
                    description: Sexe à la naissance
                dateNaissance:
                    type: string
                    format: date
                nam:
                    type: string
                    description: Numéro d'assurance maladie
        PatientUpdate:
            type: object
            properties:
                prenom: { type: string }
                nom: { type: string }
                sexeActuel:
                    type: string
                    nullable: true
                    enum: [M, F, O, NA]
                    description: Sexe actuel
                courriel:
                    type: string
                    format: email
                    nullable: true
                nam:
                    type: string
                    description: Ne change qu'exceptionnellement
        Patient:
            allOf:
                - $ref: '#/components/schemas/PatientCreate'
                - type: object
                  properties:
                      braverPatientId:
                          type: string

        ClientCreate:
            type: object
            required: [id, nom]
            properties:
                id:
                    type: string
                    description: Identifiant unique du client côté Ofys
                nom:
                    type: string
                    description: Nom de la clinique/organisation
                lieux:
                    type: array
                    items: { $ref: '#/components/schemas/PracticeLocationCreate' }
                    description: Lieux de pratique associés au client

        Client:
            allOf:
                - $ref: '#/components/schemas/ClientCreate'
                - type: object
                  properties:
                      braverClientId:
                          type: string
                          description: Identifiant unique du client côté Braver

        PracticeLocationCreate:
            type: object
            required: [nom, typeLieu]
            properties:
                nom:
                    type: string
                    description: Nom du lieu de pratique
                typeLieu:
                    type: string
                    format: uuid
                    description: UUID du type de lieu (voir GET /typesLieux dans l'API frontend)
                rue:
                    type: string
                    nullable: true
                    description: Numéro et nom de la rue
                codePostal:
                    type: string
                    nullable: true
                    description: Code postal
                ville:
                    type: string
                    nullable: true
                    description: Ville/localité
                pays:
                    type: string
                    nullable: true
                    description: Pays (code ISO 3166-1 alpha-2 recommandé, ex. CH, FR)
                longitude:
                    type: number
                    format: double
                    nullable: true
                    description: Coordonnée géographique
                latitude:
                    type: number
                    format: double
                    nullable: true
                    description: Coordonnée géographique

        PracticeLocation:
            allOf:
                - $ref: '#/components/schemas/PracticeLocationCreate'
                - type: object
                  properties:
                      id:
                          type: string
                          description: Identifiant unique du lieu côté Braver

        ApiError:
            type: object
            required: [error]
            properties:
                error:
                    type: object
                    required: [code, message, timestamp, traceId]
                    properties:
                        code:
                            type: string
                            description: Code d'erreur machine-readable (ex. VALIDATION_REQUIRED_FIELD, USER_ALREADY_EXISTS)
                            example: USER_ALREADY_EXISTS
                        message:
                            type: string
                            description: Message d'erreur lisible par l'humain
                            example: Un utilisateur avec le ID Ofys 'prof-123' existe déjà
                        details:
                            type: object
                            description: Détails additionnels spécifiques à l'erreur
                            additionalProperties: true
                            example:
                                userId: prof-123
                                field: id
                        timestamp:
                            type: string
                            format: date-time
                            description: Timestamp ISO 8601 de l'erreur
                        traceId:
                            type: string
                            description: Identifiant unique pour tracer l'erreur en production
                            example: abc-123-def-456
